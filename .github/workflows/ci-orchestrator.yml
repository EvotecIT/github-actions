name: Evotec CI Orchestrator

on:
  workflow_call:
    inputs:
      # Project
      solution:
        description: 'Path or glob to .sln'
        required: false
        default: '**/*.sln'
        type: string
      # .NET (explicit per-OS pairs)
      dotnet_windows_runs_on:
        description: 'JSON array of runner labels for the Windows job'
        required: false
        default: '["windows-latest"]'
        type: string
      dotnet_windows_frameworks:
        description: 'JSON array of Windows TFMs to test'
        required: false
        default: '["net472","net8.0"]'
        type: string
      dotnet_ubuntu_runs_on:
        description: 'JSON array of runner labels for the Ubuntu job'
        required: false
        default: '["ubuntu-latest"]'
        type: string
      dotnet_ubuntu_frameworks:
        description: 'JSON array of Ubuntu TFMs to test'
        required: false
        default: '["net8.0"]'
        type: string
      dotnet_macos_runs_on:
        description: 'JSON array of runner labels for the macOS job'
        required: false
        default: '["macos-latest"]'
        type: string
      dotnet_macos_frameworks:
        description: 'JSON array of macOS TFMs to test'
        required: false
        default: '["net8.0"]'
        type: string
      codecov_enable:
        description: 'Upload coverage to Codecov in .NET jobs'
        required: false
        default: true
        type: boolean
      dotnet_build_configuration:
        description: 'Build configuration for .NET jobs'
        required: false
        default: 'Release'
        type: string
      # PowerShell
      ps_windows_runs_on:
        description: 'JSON array of runner labels for Pester on Windows'
        required: false
        default: '["windows-latest"]'
        type: string
      ps_windows_versions:
        description: 'JSON array of PS versions for Windows (e.g. ["5.1","7"])'
        required: false
        default: '["5.1","7"]'
        type: string
      ps_ubuntu_runs_on:
        description: 'JSON array of runner labels for Pester on Ubuntu (empty to disable)'
        required: false
        default: '[]'
        type: string
      ps_ubuntu_versions:
        description: 'JSON array of PS versions for Ubuntu (usually ["7"])'
        required: false
        default: '["7"]'
        type: string
      ps_macos_runs_on:
        description: 'JSON array of runner labels for Pester on macOS (empty to disable)'
        required: false
        default: '[]'
        type: string
      ps_macos_versions:
        description: 'JSON array of PS versions for macOS (usually ["7"])'
        required: false
        default: '["7"]'
        type: string
      ps_module_manifest:
        description: 'Path to module .psd1'
        required: false
        default: ''
        type: string
      ps_test_script:
        description: 'Optional custom Pester test script'
        required: false
        default: ''
        type: string
      ps_tests_path:
        description: 'Folder to search for *.Tests.ps1'
        required: false
        default: 'Module/Tests'
        type: string
      ps_empty_tests_behavior:
        description: "Behavior when no Pester tests found: 'skip' | 'warn' | 'fail'"
        required: false
        default: 'skip'
        type: string
      # Claude
      claude_review:
        description: 'Run Claude code review on PRs'
        required: false
        default: false
        type: boolean
      claude_runs_on:
        description: 'JSON array of runners for Claude review'
        required: false
        default: '["ubuntu-latest"]'
        type: string
      post_pr_comment:
        description: 'Always post consolidated PR comment'
        required: false
        default: true
        type: boolean
    secrets:
      CODECOV_TOKEN:
        required: false
      CLAUDE_CODE_OAUTH_TOKEN:
        required: false

jobs:
  dotnet-windows:
    name: .NET Windows
    if: ${{ fromJSON(inputs.dotnet_windows_runs_on)[0] != null }}
    uses: EvotecIT/github-actions/.github/workflows/ci-dotnet.yml@master
    with:
      os: ${{ inputs.dotnet_windows_runs_on }}
      solution: ${{ inputs.solution }}
      frameworks: ${{ inputs.dotnet_windows_frameworks }}
      summarize_failures: true
      codecov_enable: ${{ inputs.codecov_enable }}
      build_configuration: ${{ inputs.dotnet_build_configuration }}
    secrets: inherit

  dotnet-ubuntu:
    name: .NET Ubuntu
    if: ${{ fromJSON(inputs.dotnet_ubuntu_runs_on)[0] != null }}
    uses: EvotecIT/github-actions/.github/workflows/ci-dotnet.yml@master
    with:
      os: ${{ inputs.dotnet_ubuntu_runs_on }}
      solution: ${{ inputs.solution }}
      frameworks: ${{ inputs.dotnet_ubuntu_frameworks }}
      summarize_failures: true
      codecov_enable: ${{ inputs.codecov_enable }}
      build_configuration: ${{ inputs.dotnet_build_configuration }}
    secrets: inherit

  dotnet-macos:
    name: .NET macOS
    if: ${{ fromJSON(inputs.dotnet_macos_runs_on)[0] != null }}
    uses: EvotecIT/github-actions/.github/workflows/ci-dotnet.yml@master
    with:
      os: ${{ inputs.dotnet_macos_runs_on }}
      solution: ${{ inputs.solution }}
      frameworks: ${{ inputs.dotnet_macos_frameworks }}
      summarize_failures: true
      codecov_enable: ${{ inputs.codecov_enable }}
      build_configuration: ${{ inputs.dotnet_build_configuration }}
    secrets: inherit

  pester-windows:
    name: PowerShell (Windows)
    if: ${{ fromJSON(inputs.ps_windows_runs_on)[0] != null }}
    uses: EvotecIT/github-actions/.github/workflows/ci-powershell.yml@master
    with:
      runs_on: ${{ inputs.ps_windows_runs_on }}
      module_manifest: ${{ inputs.ps_module_manifest }}
      solution: ${{ inputs.solution }}
      ps_versions: ${{ inputs.ps_windows_versions }}
      test_script: ${{ inputs.ps_test_script }}
      tests_path: ${{ inputs.ps_tests_path }}
      empty_tests_behavior: ${{ inputs.ps_empty_tests_behavior }}
      summarize_failures: true
      dotnet_version: '8.0.x'
    secrets: inherit

  pester-ubuntu:
    name: PowerShell (Ubuntu)
    if: ${{ fromJSON(inputs.ps_ubuntu_runs_on)[0] != null }}
    uses: EvotecIT/github-actions/.github/workflows/ci-powershell.yml@master
    with:
      runs_on: ${{ inputs.ps_ubuntu_runs_on }}
      module_manifest: ${{ inputs.ps_module_manifest }}
      solution: ${{ inputs.solution }}
      ps_versions: ${{ inputs.ps_ubuntu_versions }}
      test_script: ${{ inputs.ps_test_script }}
      tests_path: ${{ inputs.ps_tests_path }}
      empty_tests_behavior: ${{ inputs.ps_empty_tests_behavior }}
      summarize_failures: true
      dotnet_version: '8.0.x'
    secrets: inherit

  pester-macos:
    name: PowerShell (macOS)
    if: ${{ fromJSON(inputs.ps_macos_runs_on)[0] != null }}
    uses: EvotecIT/github-actions/.github/workflows/ci-powershell.yml@master
    with:
      runs_on: ${{ inputs.ps_macos_runs_on }}
      module_manifest: ${{ inputs.ps_module_manifest }}
      solution: ${{ inputs.solution }}
      ps_versions: ${{ inputs.ps_macos_versions }}
      test_script: ${{ inputs.ps_test_script }}
      tests_path: ${{ inputs.ps_tests_path }}
      empty_tests_behavior: ${{ inputs.ps_empty_tests_behavior }}
      summarize_failures: true
      dotnet_version: '8.0.x'
    secrets: inherit

  claude-review:
    if: ${{ inputs.claude_review && github.event_name == 'pull_request' }}
    uses: EvotecIT/github-actions/.github/workflows/review-claude.yml@master
    with:
      runs_on: ${{ inputs.claude_runs_on }}
    secrets: inherit

  summary:
    name: Consolidated Test Summary
    needs: [dotnet-windows, dotnet-ubuntu, dotnet-macos, pester-windows, pester-ubuntu, pester-macos]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Download TRX artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: trx-*
          path: artifacts
          merge-multiple: true

      - name: Download Pester results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-ps*
          path: artifacts
          merge-multiple: true

      - name: Download count summaries
        uses: actions/download-artifact@v4
        with:
          pattern: counts-*
          path: artifacts
          merge-multiple: true

      - name: Aggregate failing tests
        id: aggregate
        uses: evotecit/github-actions/.github/actions/aggregate-summary@master
        with:
          artifacts_path: artifacts
          res_dotnet_windows: ${{ needs.dotnet-windows.result }}
          res_dotnet_ubuntu:  ${{ needs.dotnet-ubuntu.result }}
          res_dotnet_macos:   ${{ needs.dotnet-macos.result }}
          res_pester_windows: ${{ needs.pester-windows.result }}
          res_pester_ubuntu:  ${{ needs.pester-ubuntu.result }}
          res_pester_macos:   ${{ needs.pester-macos.result }}
          summary_comment_tag: evotec-ci-aggregate-summary
          post_pr_comment: ${{ inputs.post_pr_comment }}

      # PR comment now posted from the composite action above when enabled
