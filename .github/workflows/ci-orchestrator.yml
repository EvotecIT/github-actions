name: Evotec CI Orchestrator

on:
  workflow_call:
    inputs:
      # Project
      solution:
        description: 'Path or glob to .sln'
        required: false
        default: '**/*.sln'
        type: string
      # .NET
      os_dotnet:
        description: 'JSON array of OS runners for .NET (e.g. ["windows-latest","ubuntu-latest","macos-latest"])'
        required: false
        default: '["windows-latest","ubuntu-latest","macos-latest"]'
        type: string
      dotnet_frameworks:
        description: 'JSON array of TFMs to test (optional, auto-detect when empty)'
        required: false
        default: '[]'
        type: string
      enable_codecov:
        description: 'Upload coverage to Codecov in .NET jobs'
        required: false
        default: true
        type: boolean
      dotnet_build_configuration:
        description: 'Build configuration for .NET jobs'
        required: false
        default: 'Release'
        type: string
      # PowerShell
      ps_run:
        description: 'Run PowerShell Pester tests'
        required: false
        default: true
        type: boolean
      ps_versions:
        description: 'JSON array of PowerShell versions to test'
        required: false
        default: '["5.1","7"]'
        type: string
      ps_runs_on:
        description: 'JSON array of runner labels for PowerShell tests'
        required: false
        default: '["windows-latest"]'
        type: string
      ps_module_manifest:
        description: 'Path to module .psd1'
        required: false
        default: ''
        type: string
      ps_test_script:
        description: 'Optional custom Pester test script'
        required: false
        default: ''
        type: string
      ps_tests_path:
        description: 'Folder to search for *.Tests.ps1'
        required: false
        default: 'Module/Tests'
        type: string
      ps_empty_tests_behavior:
        description: "Behavior when no Pester tests found: 'skip' | 'warn' | 'fail'"
        required: false
        default: 'fail'
        type: string
      # Claude
      claude_review:
        description: 'Run Claude code review on PRs'
        required: false
        default: false
        type: boolean
      claude_runs_on:
        description: 'JSON array of runners for Claude review'
        required: false
        default: '["ubuntu-latest"]'
        type: string
      post_pr_comment:
        description: 'Always post consolidated PR comment'
        required: false
        default: true
        type: boolean
    secrets:
      CODECOV_TOKEN:
        required: false
      CLAUDE_CODE_OAUTH_TOKEN:
        required: false

jobs:
  dotnet-windows:
    if: contains(fromJSON(inputs.os_dotnet), 'windows-latest')
    uses: EvotecIT/github-actions/.github/workflows/ci-dotnet.yml@master
    with:
      os: '["windows-latest"]'
      solution: ${{ inputs.solution }}
      frameworks: ${{ inputs.dotnet_frameworks }}
      summarize_failures: true
      enable_codecov: ${{ inputs.enable_codecov }}
      build_configuration: ${{ inputs.dotnet_build_configuration }}
    secrets: inherit

  dotnet-ubuntu:
    if: contains(fromJSON(inputs.os_dotnet), 'ubuntu-latest')
    uses: EvotecIT/github-actions/.github/workflows/ci-dotnet.yml@master
    with:
      os: '["ubuntu-latest"]'
      solution: ${{ inputs.solution }}
      frameworks: ${{ inputs.dotnet_frameworks }}
      summarize_failures: true
      enable_codecov: ${{ inputs.enable_codecov }}
      build_configuration: ${{ inputs.dotnet_build_configuration }}
    secrets: inherit

  dotnet-macos:
    if: contains(fromJSON(inputs.os_dotnet), 'macos-latest')
    uses: EvotecIT/github-actions/.github/workflows/ci-dotnet.yml@master
    with:
      os: '["macos-latest"]'
      solution: ${{ inputs.solution }}
      frameworks: ${{ inputs.dotnet_frameworks }}
      summarize_failures: true
      enable_codecov: ${{ inputs.enable_codecov }}
      build_configuration: ${{ inputs.dotnet_build_configuration }}
    secrets: inherit

  pester-windows:
    if: ${{ inputs.ps_run }}
    uses: EvotecIT/github-actions/.github/workflows/ci-powershell.yml@master
    with:
      runs_on: ${{ inputs.ps_runs_on }}
      module_manifest: ${{ inputs.ps_module_manifest }}
      solution: ${{ inputs.solution }}
      ps_versions: ${{ inputs.ps_versions }}
      test_script: ${{ inputs.ps_test_script }}
      tests_path: ${{ inputs.ps_tests_path }}
      empty_tests_behavior: ${{ inputs.ps_empty_tests_behavior }}
      summarize_failures: true
      dotnet_version: '8.0.x'
    secrets: inherit

  claude-review:
    if: ${{ inputs.claude_review && github.event_name == 'pull_request' }}
    uses: EvotecIT/github-actions/.github/workflows/review-claude.yml@master
    with:
      runs_on: ${{ inputs.claude_runs_on }}
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  summary:
    name: Consolidated Test Summary
    needs: [dotnet-windows, dotnet-ubuntu, dotnet-macos, pester-windows]
    if: always()
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Download TRX artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: trx-*
          path: artifacts
          merge-multiple: true

      - name: Download Pester results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-ps*
          path: artifacts
          merge-multiple: true

      - name: Download count summaries
        uses: actions/download-artifact@v4
        with:
          pattern: counts-*
          path: artifacts
          merge-multiple: true

      - name: Aggregate failing tests
        id: aggregate
        uses: evotecit/github-actions/.github/actions/aggregate-summary@master
        with:
          artifacts_path: artifacts
          res_dotnet_windows: ${{ needs.dotnet-windows.result }}
          res_dotnet_ubuntu:  ${{ needs.dotnet-ubuntu.result }}
          res_dotnet_macos:   ${{ needs.dotnet-macos.result }}
          res_pester_windows: ${{ needs.pester-windows.result }}
          summary_comment_tag: evotec-ci-aggregate-summary
          post_pr_comment: ${{ inputs.post_pr_comment }}

      # PR comment now posted from the composite action above when enabled
